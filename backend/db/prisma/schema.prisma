datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

/////////////////////
// ENUMS
/////////////////////

enum Role {
  USER
  ADMIN
  SUPERADMIN
}

enum UserStatus {
  SUBSCRIBED
  CANCELLED
}

enum EventStatus {
  SCHEDULED
  CANCELLED
}

enum SubscriptionStatus {
  PENDING
  ACTIVE
  EXPIRED
  CANCELLED
}

enum GroupLevel {
  ALL
  OPEN
  ADVANCED
  DEPTH
}

/////////////////////
// MODELS
/////////////////////

model User {
  id           String      @id @default(uuid())
  email        String      @unique
  password     String
  firstName    String?
  lastName     String?
  role         Role        @default(USER)
  status       UserStatus  @default(SUBSCRIBED)
  refreshToken String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  groups        UserGroup[]
  signups       EventSignup[]
  createdEvents Event[]        @relation("CreatedBy")
  subscriptions Subscription[]
}

model Group {
  id          Int         @id @default(autoincrement())
  name        String      @unique
  description String?
  level       GroupLevel @default(ALL)
  users       UserGroup[]
}

model Subscription {
  id         Int                @id @default(autoincrement())
  user       User               @relation(fields: [userId], references: [id])
  userId     String
  startDate  DateTime
  endDate    DateTime
  amount     Float
  currency   String             @default("EUR")
  status     SubscriptionStatus @default(PENDING)
  paymentRef String?
  createdAt  DateTime           @default(now())

  userGroups UserGroup[]
}

model UserGroup {
  user           User         @relation(fields: [userId], references: [id])
  userId         String
  group          Group        @relation(fields: [groupId], references: [id])
  groupId        Int
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])
  subscriptionId Int
  validFrom      DateTime
  validTo        DateTime
  isActive       Boolean      @default(true)
  assignedAt     DateTime     @default(now())

  @@id([userId, groupId, subscriptionId])
}

model EventCategory {
  id    Int    @id @default(autoincrement())
  code  String @unique
  label String
  events Event[]
}

model Event {
  id          Int         @id @default(autoincrement())
  title       String
  description String?
  equipment   String?
  note        String?
  location    String?
  date        DateTime    @db.Date
  startTime   String
  endTime     String
  maxSlots    Int         @default(10)
  status      EventStatus @default(SCHEDULED)

  category    EventCategory @relation(fields: [categoryId], references: [id])
  categoryId  Int

  creator     User        @relation("CreatedBy", fields: [creatorId], references: [id])
  creatorId   String

  signups     EventSignup[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model EventSignup {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventId   Int
  createdAt DateTime @default(now())

  @@unique([userId, eventId])
}
